<html>

<head>

<body>
  <div id="join-room">
    <input id="username" type="text" />
    <button type="button" onclick="return onJoin(event)">Join</button>
  </div>
  <div id="message">
    <input id="message" type="text" onkeydown="return onSendMessage(event)" />
  </div>
  <div id="response" />
</body>
<script>
  let socketId = null;
  let anotherUserSocketId = null;

  async function onJoin(e) {
      const username = document.getElementById("username").value;
      await fetch('http://localhost:3001/api/chat/pubsub-join', {
        method: 'POST',
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify({ username, socketId })
      });
  }

  async function onSendMessage() {
    await fetch('http://localhost:3001/api/chat/pubsub-message', {
        method: 'POST',
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify({ username, socketId })
      });
  }

  const socket = new WebSocket('ws://localhost:8080');
  socket.onopen = function () { 

    socket.send(JSON.stringify({
      event: 'PUBSUB_CHAT_HANDSHAKE_EVENT'
    }));

    socket.onmessage = function (packet) {
      const res = JSON.parse(packet.data);

      switch(res.event) {
        case 'PUBSUB_CHAT_HANDSHAKE_RESULT':
          console.log('PUBSUB_CHAT_HANDSHAKE_RESULT');
          const data = JSON.parse(res.data);
          if (data.socketId) { 
            console.log('socketId: ' + data.socketId);
            console.log(data.users);
            socketId = data.socketId 
          } 
          break;
        case 'PUBSUB_CHAT_JOIN_RESULT': 
          console.log('PUBSUB_CHAT_JOIN_RESULT');
          console.log('joined: ' + res.data.id);
          const div = document.getElementById("response");
          const text = document.createTextNode(res.data.username + ' joined');
          const br = document.createElement('br');
          div.appendChild(text)
          div.appendChild(br);
          break;
      }
    }
  }
</script>
</head>

<body></body>

</html>